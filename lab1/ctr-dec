#!/usr/bin/env python3
from Crypto.Cipher import AES
from sys import argv, exit
import sys
import numpy as np

def main():

	keyfile=sys.argv[1]
	encryptedfile=sys.argv[2]
	outputfile=sys.argv[3]

	p=open(keyfile,"r")
	hex_key=p.read()
	p.close()
	key=bytes.fromhex(hex_key)
	decipher = AES.new(key, AES.MODE_ECB)

	o=open(outputfile,'wb')
	final=[]

	with open(encryptedfile, 'rb') as f:
		iv=f.read(16)
		intiv=int.from_bytes(iv, byteorder='big')
		intiv+=1
		while 1:
			msg=bytearray(f.read(16))
			if msg == bytes('','utf-8'):
				break
			iv2=bytearray(decipher.encrypt(intiv.to_bytes(16,byteorder='big')))
			for x in range(len(msg)):
				final.append(iv2[x] ^ msg[x])
			intiv+=1

	o.write(bytes(final))

if __name__ == "__main__":
	exit(main())
